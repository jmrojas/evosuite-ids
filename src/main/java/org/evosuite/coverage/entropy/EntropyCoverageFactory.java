package org.evosuite.coverage.entropy;import java.io.BufferedReader;import java.io.File;import java.io.FileReader;import java.io.IOException;import java.util.ArrayList;import java.util.HashSet;import java.util.List;import java.util.Set;import org.evosuite.Properties;import org.evosuite.TestGenerationContext;import org.evosuite.graphs.cfg.BytecodeInstruction;import org.evosuite.graphs.cfg.BytecodeInstructionPool;import org.evosuite.testsuite.AbstractFitnessFactory;import org.evosuite.utils.LoggingUtils;/** *  */public class EntropyCoverageFactory extends		AbstractFitnessFactory<EntropyCoverageTestFitness>{	private static boolean			called = false;	private static boolean			debug = false;	private static int				number_of_ones = 0;	private static List<List<Boolean>>	matrix = new ArrayList<List<Boolean>>();	private static List<EntropyCoverageTestFitness> goals = new ArrayList<EntropyCoverageTestFitness>();	private static Set<Integer> lineNumbers = new HashSet<Integer>();	private static void computeGoals()	{		if (called)			return ;		Properties.MINIMIZE = false; // FIXME put this somewhere else		long start = System.currentTimeMillis();		String targetMethod = Properties.TARGET_METHOD;		String targetClass = Properties.TARGET_CLASS;		for (String className : BytecodeInstructionPool.getInstance(TestGenerationContext.getClassLoader()).knownClasses())		{			if (!(targetClass.equals("") || className.endsWith(targetClass)))				continue;			for (String methodName : BytecodeInstructionPool.getInstance(TestGenerationContext.getClassLoader()).knownMethods(className))			{				if (!targetMethod.equals("") && !methodName.equals(targetMethod))					continue;				for (BytecodeInstruction ins : BytecodeInstructionPool.getInstance(TestGenerationContext.getClassLoader()).getInstructionsIn(className, methodName)) {					if (isUsable(ins))						goals.add(new EntropyCoverageTestFitness(ins));				}			}		}		long end = System.currentTimeMillis();		LoggingUtils.getEvoLogger().info("* Total number of coverage goals: "		                                         + goals.size() + " took "		                                         + (end - start) + "ms");		called = true;		if (debug) {			for (EntropyCoverageTestFitness e : goals)				LoggingUtils.getEvoLogger().info(e.toString());		}		loadOriginalMatrix();	}	private static boolean isUsable(BytecodeInstruction ins) {		if (lineNumbers.add(ins.getLineNumber()) == false) // the line number already exists, and cannot be added			return false;		return ins.isLineNumber();	}	private static void loadOriginalMatrix()	{		/*		 * Read the original matrix if the Coverage File exists		 */		BufferedReader br = null;		try		{			String sCurrentLine;			br = new BufferedReader(new FileReader("evosuite-report" + File.separator + "data" + File.separator + Properties.TARGET_CLASS + ".matrix"));			String[] split;			while ((sCurrentLine = br.readLine()) != null)			{				split = sCurrentLine.split(" ");				List<Boolean> test = new ArrayList<Boolean>();				for (int i = 0; i < split.length - 1; i++) // - 1, because we don't want the test results				{					if (split[i].compareTo("1") == 0) {						number_of_ones++;						test.add(true);					}					else						test.add(false);				}				matrix.add(test);			}			double rho = ((double)number_of_ones) / ((double)(getNumberOfTests() * getNumberOfGoals()));			LoggingUtils.getEvoLogger().info("* Original fitness: " + rho);		}		catch (IOException e) {			// the coverage matrix file does not exist, ok no problem... we will generate new test cases from scratch		}		finally {			try {				if (br != null)					br.close();			}			catch (IOException ex) {				ex.printStackTrace();			}		}	}	public static int getNumberOfOnes() {		return number_of_ones;	}	public static int getNumberOfTests() {		if (matrix.isEmpty())			return 0;		return matrix.size();	}	public static int getNumberOfGoals() {		return goals.size();	}	public static boolean exists(List<Boolean> newTest) {		return matrix.contains(newTest);	}	@Override	public List<EntropyCoverageTestFitness> getCoverageGoals() {		if (!called)			computeGoals();		return goals;	}	public static List<EntropyCoverageTestFitness> retrieveCoverageGoals() {		if (!called)			computeGoals();		return goals;	}}